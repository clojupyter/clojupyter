#!/bin/env bash

USER_LIB_PATH=$(if [[ $(uname -s) == Darwin ]]; then
                  echo $HOME/Library
              else
                  echo $HOME/.local/lib
              fi)
SYSTEM_LIB_PATH=$(if [[ $(uname -s) == Darwin ]]; then
                  echo /usr/lib
              else
                  echo /usr/local/lib
              fi)

KERNEL=clojupyter-$($(dirname $0)/version)

while [[ $# -gt 0 ]]; do
    case $1 in
        --kernel|-k)
        KERNEL=$2
        shift
        shift
        ;;
        *)
        TARGET=$1
        shift
        ;;
    esac
done

[[ -d $USER_LIB_PATH/$KERNEL || -d $SYSTEM_LIB_PATH/$KERNEL ]] ||\
{ echo Can\'t find the kernel dir 2>/dev/null;
  exit 1; }

[[ -d $SYSTEM_LIB_PATH/$KERNEL ]] && WORKDIR=$SYSTEM_LIB_PATH/$KERNEL
[[ -d $USER_LIB_PATH/$KERNEL ]] && WORKDIR=$USER_LIB_PATH/$KERNEL

[[ -r $WORKDIR/plugins || -w $WORKDIR/plugins/enabled ]] ||\
{ echo The kernel does not appear to support plugins >&2;
  exit 2; }

[[ -n $TARGET ]] ||\
{ echo Must provide a plugin to disable 2>/dev/null;
  exit 3; }

enabled_plugs=$(ls $WORKDIR/plugins/enabled)

new_plugs=
for plug in $enabled_plugs; do
    [[ ${plug:0:-4} =~ $TARGET ]] &&\
    { new_plugs+=$plug;
      echo Disabling plugin $plug for $KERNEL >&2; }
done

[[ -n "$new_plugs" ]] &&\
{ cd $WORKDIR/plugins/enabled;
  for plug in $new_plugs; do
      rm $plug
  done; }

exit 0
