#!/bin/env bash

USER_DATA_PATH=$(if [[ -d ${JUPYTER_DATA_DIR}/kernels ]]; then
                echo ${JUPYTER_DATA_DIR}/kernels
            elif [[ $(uname -s) == Darwin ]]; then
                echo $HOME/Library/Jupyter/kernels
            elif [[ -d ${XDG_DATA_HOME}/jupyter/kernels ]]; then
                echo $XDG_DATA_HOME/jupyter/kernels
            else
                echo $HOME/.local/share/jupyter/kernels
            fi)
USER_LIB_PATH=$(if [[ $(uname -s) == Darwin ]]; then
                  echo $HOME/Library
              else
                  echo $HOME/.local/lib
              fi)
SYSTEM_DATA_PATH=$(if [[ $(uname -s) == Darwin ]]; then
                  echo /usr/share/jupyter/kernels
              else
                  echo /usr/local/share/jupyter/kernels
              fi)
SYSTEM_LIB_PATH=$(if [[ $(uname -s) == Darwin ]]; then
                  echo /usr/lib
              else
                  echo /usr/local/lib
              fi)
KERNEL=clojupyter-$($(dirname $0)/version)

while [[ $# -gt 0 ]]; do
    case $1 in
        --kernel|-k)
        KERNEL=$2
        shift
        shift
        ;;
        *)
        TARGET=$1
        shift
        ;;
    esac
done

[[ -d $USER_DATA_PATH/$KERNEL || -d $SYSTEM_DATA_PATH/$KERNEL ]] ||\
{ echo Can\'t find the kernel dir 2>/dev/null;
  exit 1; }

[[ -d $SYSTEM_DATA_PATH/$KERNEL ]] &&\
{ KDIR=$SYSTEM_DATA_PATH/$KERNEL;
  LIBDIR=$SYSTEM_LIB_PATH/$KERNEL; }

[[ -d $USER_DATA_PATH/$KERNEL ]] &&\
{ KDIR=$USER_DATA_PATH/$KERNEL;
  LIBDIR=$USER_LIB_PATH/$KERNEL; }

[[ -r $LIBDIR/plugins || -w $LIBDIR/plugins/enabled ]] ||\
{ echo Can\'t write to plugin directory. >&2;
  exit 2; }

[[ -n $TARGET ]] ||\
{ echo Must provide a plugin to enable 2>/dev/null;
  exit 3; }

matches=
for plug in $LIBDIR/plugins/*.jar; do
    [[ $(basename ${plug}) != "*.jar" && $(basename ${plug:0:-4}) =~ $TARGET ]] &&\
    matches+="$plug "
done

[[ -n $matches ]] ||\
{ echo No plugin found that matches $TARGET >&2;
  exit 3; }

enabled_plugs=
for plug in $(ls $LIBDIR/plugins/enabled); do
    enabled_plugs+=$LIBDIR/plugins/$plug
done

new_plugs="$enabled_plugs"
for match in $matches; do
    (echo "$enabled_plugs" | grep $match &>/dev/null) ||\
    { new_plugs=$(cat <(echo "$new_plugs") <(echo "$match"));
      echo Enabling plugin $(basename ${match:0:-4}) for $KERNEL >&2; }
done

[[ "$new_plugs" != "$enabled_plugs" ]] &&\
{ cd $LIBDIR/plugins/enabled;
  for plug in $new_plugs; do
      ln -s ../$(basename $plug) .
  done; }

exit 0
